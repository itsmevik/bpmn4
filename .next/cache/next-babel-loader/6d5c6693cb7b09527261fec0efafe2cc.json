{"ast":null,"code":"import inherits from 'inherits';\nimport CreateMoveSnapping from 'diagram-js/lib/features/snapping/CreateMoveSnapping';\nimport { isSnapped, setSnapped, topLeft, bottomRight } from 'diagram-js/lib/features/snapping/SnapUtil';\nimport { isExpanded } from '../../util/DiUtil';\nimport { is } from '../../util/ModelUtil';\nimport { asTRBL, getMid } from 'diagram-js/lib/layout/LayoutUtil';\nimport { getBoundaryAttachment } from './BpmnSnappingUtil';\nimport { forEach } from 'min-dash';\nvar HIGH_PRIORITY = 1500;\n/**\n * Snap during create and move.\n *\n * @param {EventBus} eventBus\n * @param {Injector} injector\n */\n\nexport default function BpmnCreateMoveSnapping(eventBus, injector) {\n  injector.invoke(CreateMoveSnapping, this); // creating first participant\n\n  eventBus.on(['create.move', 'create.end'], HIGH_PRIORITY, setSnappedIfConstrained); // snap boundary events\n\n  eventBus.on(['create.move', 'create.end', 'shape.move.move', 'shape.move.end'], HIGH_PRIORITY, function (event) {\n    var context = event.context,\n        canExecute = context.canExecute,\n        target = context.target;\n    var canAttach = canExecute && (canExecute === 'attach' || canExecute.attach);\n\n    if (canAttach && !isSnapped(event)) {\n      snapBoundaryEvent(event, target);\n    }\n  });\n}\ninherits(BpmnCreateMoveSnapping, CreateMoveSnapping);\nBpmnCreateMoveSnapping.$inject = ['eventBus', 'injector'];\n\nBpmnCreateMoveSnapping.prototype.initSnap = function (event) {\n  var snapContext = CreateMoveSnapping.prototype.initSnap.call(this, event);\n  var shape = event.shape;\n  var isMove = !!this._elementRegistry.get(shape.id); // snap to docking points\n\n  forEach(shape.outgoing, function (connection) {\n    var docking = connection.waypoints[0];\n    docking = docking.original || docking;\n    snapContext.setSnapOrigin(connection.id + '-docking', getDockingSnapOrigin(docking, isMove, event));\n  });\n  forEach(shape.incoming, function (connection) {\n    var docking = connection.waypoints[connection.waypoints.length - 1];\n    docking = docking.original || docking;\n    snapContext.setSnapOrigin(connection.id + '-docking', getDockingSnapOrigin(docking, isMove, event));\n  });\n\n  if (is(shape, 'bpmn:Participant')) {\n    // snap to borders with higher priority\n    snapContext.setSnapLocations(['top-left', 'bottom-right', 'mid']);\n  }\n\n  return snapContext;\n};\n\nBpmnCreateMoveSnapping.prototype.addSnapTargetPoints = function (snapPoints, shape, target) {\n  CreateMoveSnapping.prototype.addSnapTargetPoints.call(this, snapPoints, shape, target);\n  var snapTargets = this.getSnapTargets(shape, target);\n  forEach(snapTargets, function (snapTarget) {\n    // handle TRBL alignment\n    //\n    // * with container elements\n    // * with text annotations\n    if (isContainer(snapTarget) || areAll([shape, snapTarget], 'bpmn:TextAnnotation')) {\n      snapPoints.add('top-left', topLeft(snapTarget));\n      snapPoints.add('bottom-right', bottomRight(snapTarget));\n    }\n  });\n  var elementRegistry = this._elementRegistry; // snap to docking points if not create mode\n\n  forEach(shape.incoming, function (connection) {\n    if (elementRegistry.get(shape.id)) {\n      if (!includes(snapTargets, connection.source)) {\n        snapPoints.add('mid', getMid(connection.source));\n      }\n\n      var docking = connection.waypoints[0];\n      snapPoints.add(connection.id + '-docking', docking.original || docking);\n    }\n  });\n  forEach(shape.outgoing, function (connection) {\n    if (elementRegistry.get(shape.id)) {\n      if (!includes(snapTargets, connection.target)) {\n        snapPoints.add('mid', getMid(connection.target));\n      }\n\n      var docking = connection.waypoints[connection.waypoints.length - 1];\n      snapPoints.add(connection.id + '-docking', docking.original || docking);\n    }\n  }); // add sequence flow parents as snap targets\n\n  if (is(target, 'bpmn:SequenceFlow')) {\n    snapPoints = this.addSnapTargetPoints(snapPoints, shape, target.parent);\n  }\n\n  return snapPoints;\n};\n\nBpmnCreateMoveSnapping.prototype.getSnapTargets = function (shape, target) {\n  return CreateMoveSnapping.prototype.getSnapTargets.call(this, shape, target).filter(function (snapTarget) {\n    // do not snap to lanes\n    return !is(snapTarget, 'bpmn:Lane');\n  });\n}; // helpers //////////\n\n\nfunction snapBoundaryEvent(event, target) {\n  var targetTRBL = asTRBL(target);\n  var direction = getBoundaryAttachment(event, target);\n  var context = event.context,\n      shape = context.shape;\n  var offset;\n\n  if (shape.parent) {\n    offset = {\n      x: 0,\n      y: 0\n    };\n  } else {\n    offset = getMid(shape);\n  }\n\n  if (/top/.test(direction)) {\n    setSnapped(event, 'y', targetTRBL.top - offset.y);\n  } else if (/bottom/.test(direction)) {\n    setSnapped(event, 'y', targetTRBL.bottom - offset.y);\n  }\n\n  if (/left/.test(direction)) {\n    setSnapped(event, 'x', targetTRBL.left - offset.x);\n  } else if (/right/.test(direction)) {\n    setSnapped(event, 'x', targetTRBL.right - offset.x);\n  }\n}\n\nfunction areAll(elements, type) {\n  return elements.every(function (el) {\n    return is(el, type);\n  });\n}\n\nfunction isContainer(element) {\n  if (is(element, 'bpmn:SubProcess') && isExpanded(element)) {\n    return true;\n  }\n\n  return is(element, 'bpmn:Participant');\n}\n\nfunction setSnappedIfConstrained(event) {\n  var context = event.context,\n      createConstraints = context.createConstraints;\n\n  if (!createConstraints) {\n    return;\n  }\n\n  var top = createConstraints.top,\n      right = createConstraints.right,\n      bottom = createConstraints.bottom,\n      left = createConstraints.left;\n\n  if (left && left >= event.x || right && right <= event.x) {\n    setSnapped(event, 'x', event.x);\n  }\n\n  if (top && top >= event.y || bottom && bottom <= event.y) {\n    setSnapped(event, 'y', event.y);\n  }\n}\n\nfunction includes(array, value) {\n  return array.indexOf(value) !== -1;\n}\n\nfunction getDockingSnapOrigin(docking, isMove, event) {\n  return isMove ? {\n    x: docking.x - event.x,\n    y: docking.y - event.y\n  } : {\n    x: docking.x,\n    y: docking.y\n  };\n}","map":{"version":3,"sources":["/Users/believecreative/Kumar/bpmn/node_modules/bpmn-js/lib/features/snapping/BpmnCreateMoveSnapping.js"],"names":["inherits","CreateMoveSnapping","isSnapped","setSnapped","topLeft","bottomRight","isExpanded","is","asTRBL","getMid","getBoundaryAttachment","forEach","HIGH_PRIORITY","BpmnCreateMoveSnapping","eventBus","injector","invoke","on","setSnappedIfConstrained","event","context","canExecute","target","canAttach","attach","snapBoundaryEvent","$inject","prototype","initSnap","snapContext","call","shape","isMove","_elementRegistry","get","id","outgoing","connection","docking","waypoints","original","setSnapOrigin","getDockingSnapOrigin","incoming","length","setSnapLocations","addSnapTargetPoints","snapPoints","snapTargets","getSnapTargets","snapTarget","isContainer","areAll","add","elementRegistry","includes","source","parent","filter","targetTRBL","direction","offset","x","y","test","top","bottom","left","right","elements","type","every","el","element","createConstraints","array","value","indexOf"],"mappings":"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","sourcesContent":["import inherits from 'inherits';\n\nimport CreateMoveSnapping from 'diagram-js/lib/features/snapping/CreateMoveSnapping';\n\nimport {\n  isSnapped,\n  setSnapped,\n  topLeft,\n  bottomRight\n} from 'diagram-js/lib/features/snapping/SnapUtil';\n\nimport { isExpanded } from '../../util/DiUtil';\n\nimport { is } from '../../util/ModelUtil';\n\nimport {\n  asTRBL,\n  getMid\n} from 'diagram-js/lib/layout/LayoutUtil';\n\nimport { getBoundaryAttachment } from './BpmnSnappingUtil';\n\nimport { forEach } from 'min-dash';\n\nvar HIGH_PRIORITY = 1500;\n\n\n/**\n * Snap during create and move.\n *\n * @param {EventBus} eventBus\n * @param {Injector} injector\n */\nexport default function BpmnCreateMoveSnapping(eventBus, injector) {\n  injector.invoke(CreateMoveSnapping, this);\n\n  // creating first participant\n  eventBus.on([ 'create.move', 'create.end' ], HIGH_PRIORITY, setSnappedIfConstrained);\n\n  // snap boundary events\n  eventBus.on([\n    'create.move',\n    'create.end',\n    'shape.move.move',\n    'shape.move.end'\n  ], HIGH_PRIORITY, function(event) {\n    var context = event.context,\n        canExecute = context.canExecute,\n        target = context.target;\n\n    var canAttach = canExecute && (canExecute === 'attach' || canExecute.attach);\n\n    if (canAttach && !isSnapped(event)) {\n      snapBoundaryEvent(event, target);\n    }\n  });\n}\n\ninherits(BpmnCreateMoveSnapping, CreateMoveSnapping);\n\nBpmnCreateMoveSnapping.$inject = [\n  'eventBus',\n  'injector'\n];\n\nBpmnCreateMoveSnapping.prototype.initSnap = function(event) {\n  var snapContext = CreateMoveSnapping.prototype.initSnap.call(this, event);\n\n  var shape = event.shape;\n\n  var isMove = !!this._elementRegistry.get(shape.id);\n\n  // snap to docking points\n  forEach(shape.outgoing, function(connection) {\n    var docking = connection.waypoints[0];\n\n    docking = docking.original || docking;\n\n    snapContext.setSnapOrigin(connection.id + '-docking', getDockingSnapOrigin(docking, isMove, event));\n  });\n\n  forEach(shape.incoming, function(connection) {\n    var docking = connection.waypoints[connection.waypoints.length - 1];\n\n    docking = docking.original || docking;\n\n    snapContext.setSnapOrigin(connection.id + '-docking', getDockingSnapOrigin(docking, isMove, event));\n  });\n\n  if (is(shape, 'bpmn:Participant')) {\n\n    // snap to borders with higher priority\n    snapContext.setSnapLocations([ 'top-left', 'bottom-right', 'mid' ]);\n  }\n\n  return snapContext;\n};\n\nBpmnCreateMoveSnapping.prototype.addSnapTargetPoints = function(snapPoints, shape, target) {\n  CreateMoveSnapping.prototype.addSnapTargetPoints.call(this, snapPoints, shape, target);\n\n  var snapTargets = this.getSnapTargets(shape, target);\n\n  forEach(snapTargets, function(snapTarget) {\n\n    // handle TRBL alignment\n    //\n    // * with container elements\n    // * with text annotations\n    if (isContainer(snapTarget) || areAll([ shape, snapTarget ], 'bpmn:TextAnnotation')) {\n      snapPoints.add('top-left', topLeft(snapTarget));\n      snapPoints.add('bottom-right', bottomRight(snapTarget));\n    }\n  });\n\n  var elementRegistry = this._elementRegistry;\n\n  // snap to docking points if not create mode\n  forEach(shape.incoming, function(connection) {\n    if (elementRegistry.get(shape.id)) {\n\n      if (!includes(snapTargets, connection.source)) {\n        snapPoints.add('mid', getMid(connection.source));\n      }\n\n      var docking = connection.waypoints[0];\n      snapPoints.add(connection.id + '-docking', docking.original || docking);\n    }\n  });\n\n  forEach(shape.outgoing, function(connection) {\n    if (elementRegistry.get(shape.id)) {\n\n      if (!includes(snapTargets, connection.target)) {\n        snapPoints.add('mid', getMid(connection.target));\n      }\n\n      var docking = connection.waypoints[ connection.waypoints.length - 1 ];\n\n      snapPoints.add(connection.id + '-docking', docking.original || docking);\n    }\n  });\n\n  // add sequence flow parents as snap targets\n  if (is(target, 'bpmn:SequenceFlow')) {\n    snapPoints = this.addSnapTargetPoints(snapPoints, shape, target.parent);\n  }\n\n  return snapPoints;\n};\n\nBpmnCreateMoveSnapping.prototype.getSnapTargets = function(shape, target) {\n  return CreateMoveSnapping.prototype.getSnapTargets.call(this, shape, target)\n    .filter(function(snapTarget) {\n\n      // do not snap to lanes\n      return !is(snapTarget, 'bpmn:Lane');\n    });\n};\n\n// helpers //////////\n\nfunction snapBoundaryEvent(event, target) {\n  var targetTRBL = asTRBL(target);\n\n  var direction = getBoundaryAttachment(event, target);\n\n  var context = event.context,\n      shape = context.shape;\n\n  var offset;\n\n  if (shape.parent) {\n    offset = { x: 0, y: 0 };\n  } else {\n    offset = getMid(shape);\n  }\n\n  if (/top/.test(direction)) {\n    setSnapped(event, 'y', targetTRBL.top - offset.y);\n  } else if (/bottom/.test(direction)) {\n    setSnapped(event, 'y', targetTRBL.bottom - offset.y);\n  }\n\n  if (/left/.test(direction)) {\n    setSnapped(event, 'x', targetTRBL.left - offset.x);\n  } else if (/right/.test(direction)) {\n    setSnapped(event, 'x', targetTRBL.right - offset.x);\n  }\n}\n\nfunction areAll(elements, type) {\n  return elements.every(function(el) {\n    return is(el, type);\n  });\n}\n\nfunction isContainer(element) {\n  if (is(element, 'bpmn:SubProcess') && isExpanded(element)) {\n    return true;\n  }\n\n  return is(element, 'bpmn:Participant');\n}\n\n\nfunction setSnappedIfConstrained(event) {\n  var context = event.context,\n      createConstraints = context.createConstraints;\n\n  if (!createConstraints) {\n    return;\n  }\n\n  var top = createConstraints.top,\n      right = createConstraints.right,\n      bottom = createConstraints.bottom,\n      left = createConstraints.left;\n\n  if ((left && left >= event.x) || (right && right <= event.x)) {\n    setSnapped(event, 'x', event.x);\n  }\n\n  if ((top && top >= event.y) || (bottom && bottom <= event.y)) {\n    setSnapped(event, 'y', event.y);\n  }\n}\n\nfunction includes(array, value) {\n  return array.indexOf(value) !== -1;\n}\n\nfunction getDockingSnapOrigin(docking, isMove, event) {\n  return isMove ? (\n    {\n      x: docking.x - event.x,\n      y: docking.y - event.y\n    }\n  ) : {\n    x: docking.x,\n    y: docking.y\n  };\n}\n"]},"metadata":{},"sourceType":"module"}