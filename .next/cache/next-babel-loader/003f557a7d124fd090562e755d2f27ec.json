{"ast":null,"code":"import { assign } from 'min-dash';\nimport { getLabel } from './LabelUtil';\nimport { getBusinessObject, is } from '../../util/ModelUtil';\nimport { createCategoryValue } from '../modeling/behavior/util/CategoryUtil';\nimport { isAny } from '../modeling/util/ModelingUtil';\nimport { isExpanded } from '../../util/DiUtil';\nimport { getExternalLabelMid, isLabelExternal, hasExternalLabel, isLabel } from '../../util/LabelUtil';\nexport default function LabelEditingProvider(eventBus, bpmnFactory, canvas, directEditing, modeling, resizeHandles, textRenderer) {\n  this._bpmnFactory = bpmnFactory;\n  this._canvas = canvas;\n  this._modeling = modeling;\n  this._textRenderer = textRenderer;\n  directEditing.registerProvider(this); // listen to dblclick on non-root elements\n\n  eventBus.on('element.dblclick', function (event) {\n    activateDirectEdit(event.element, true);\n  }); // complete on followup canvas operation\n\n  eventBus.on(['autoPlace.start', 'canvas.viewbox.changing', 'drag.init', 'element.mousedown', 'popupMenu.open'], function (event) {\n    if (directEditing.isActive()) {\n      directEditing.complete();\n    }\n  }); // cancel on command stack changes\n\n  eventBus.on(['commandStack.changed'], function (e) {\n    if (directEditing.isActive()) {\n      directEditing.cancel();\n    }\n  });\n  eventBus.on('directEditing.activate', function (event) {\n    resizeHandles.removeResizers();\n  });\n  eventBus.on('create.end', 500, function (event) {\n    var context = event.context,\n        element = context.shape,\n        canExecute = event.context.canExecute,\n        isTouch = event.isTouch; // TODO(nikku): we need to find a way to support the\n    // direct editing on mobile devices; right now this will\n    // break for desworkflowediting on mobile devices\n    // as it breaks the user interaction workflow\n    // TODO(nre): we should temporarily focus the edited element\n    // here and release the focused viewport after the direct edit\n    // operation is finished\n\n    if (isTouch) {\n      return;\n    }\n\n    if (!canExecute) {\n      return;\n    }\n\n    if (context.hints && context.hints.createElementsBehavior === false) {\n      return;\n    }\n\n    activateDirectEdit(element);\n  });\n  eventBus.on('autoPlace.end', 500, function (event) {\n    activateDirectEdit(event.shape);\n  });\n\n  function activateDirectEdit(element, force) {\n    if (force || isAny(element, ['bpmn:Task', 'bpmn:TextAnnotation', 'bpmn:Group']) || isCollapsedSubProcess(element)) {\n      directEditing.activate(element);\n    }\n  }\n}\nLabelEditingProvider.$inject = ['eventBus', 'bpmnFactory', 'canvas', 'directEditing', 'modeling', 'resizeHandles', 'textRenderer'];\n/**\n * Activate direct editing for activities and text annotations.\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object with properties bounds (position and size), text and options\n */\n\nLabelEditingProvider.prototype.activate = function (element) {\n  // text\n  var text = getLabel(element);\n\n  if (text === undefined) {\n    return;\n  }\n\n  var context = {\n    text: text\n  }; // bounds\n\n  var bounds = this.getEditingBBox(element);\n  assign(context, bounds);\n  var options = {}; // tasks\n\n  if (isAny(element, ['bpmn:Task', 'bpmn:Participant', 'bpmn:Lane', 'bpmn:CallActivity']) || isCollapsedSubProcess(element)) {\n    assign(options, {\n      centerVertically: true\n    });\n  } // external labels\n\n\n  if (isLabelExternal(element)) {\n    assign(options, {\n      autoResize: true\n    });\n  } // text annotations\n\n\n  if (is(element, 'bpmn:TextAnnotation')) {\n    assign(options, {\n      resizable: true,\n      autoResize: true\n    });\n  }\n\n  assign(context, {\n    options: options\n  });\n  return context;\n};\n/**\n * Get the editing bounding box based on the element's size and position\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object containing information about position\n *                  and size (fixed or minimum and/or maximum)\n */\n\n\nLabelEditingProvider.prototype.getEditingBBox = function (element) {\n  var canvas = this._canvas;\n  var target = element.label || element;\n  var bbox = canvas.getAbsoluteBBox(target);\n  var mid = {\n    x: bbox.x + bbox.width / 2,\n    y: bbox.y + bbox.height / 2\n  }; // default position\n\n  var bounds = {\n    x: bbox.x,\n    y: bbox.y\n  };\n  var zoom = canvas.zoom();\n\n  var defaultStyle = this._textRenderer.getDefaultStyle(),\n      externalStyle = this._textRenderer.getExternalStyle(); // take zoom into account\n\n\n  var externalFontSize = externalStyle.fontSize * zoom,\n      externalLineHeight = externalStyle.lineHeight,\n      defaultFontSize = defaultStyle.fontSize * zoom,\n      defaultLineHeight = defaultStyle.lineHeight;\n  var style = {\n    fontFamily: this._textRenderer.getDefaultStyle().fontFamily,\n    fontWeight: this._textRenderer.getDefaultStyle().fontWeight\n  }; // adjust for expanded pools AND lanes\n\n  if (is(element, 'bpmn:Lane') || isExpandedPool(element)) {\n    assign(bounds, {\n      width: bbox.height,\n      height: 30 * zoom,\n      x: bbox.x - bbox.height / 2 + 15 * zoom,\n      y: mid.y - 30 * zoom / 2\n    });\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: 7 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 5 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px',\n      transform: 'rotate(-90deg)'\n    });\n  } // internal labels for tasks and collapsed call activities,\n  // sub processes and participants\n\n\n  if (isAny(element, ['bpmn:Task', 'bpmn:CallActivity']) || isCollapsedPool(element) || isCollapsedSubProcess(element)) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height\n    });\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: 7 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 5 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px'\n    });\n  } // internal labels for expanded sub processes\n\n\n  if (isExpandedSubProcess(element)) {\n    assign(bounds, {\n      width: bbox.width,\n      x: bbox.x\n    });\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: 7 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 5 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px'\n    });\n  }\n\n  var width = 90 * zoom,\n      paddingTop = 7 * zoom,\n      paddingBottom = 4 * zoom; // external labels for events, data elements, gateways, groups and connections\n\n  if (target.labelTarget) {\n    assign(bounds, {\n      width: width,\n      height: bbox.height + paddingTop + paddingBottom,\n      x: mid.x - width / 2,\n      y: bbox.y - paddingTop\n    });\n    assign(style, {\n      fontSize: externalFontSize + 'px',\n      lineHeight: externalLineHeight,\n      paddingTop: paddingTop + 'px',\n      paddingBottom: paddingBottom + 'px'\n    });\n  } // external label not yet created\n\n\n  if (isLabelExternal(target) && !hasExternalLabel(target) && !isLabel(target)) {\n    var externalLabelMid = getExternalLabelMid(element);\n    var absoluteBBox = canvas.getAbsoluteBBox({\n      x: externalLabelMid.x,\n      y: externalLabelMid.y,\n      width: 0,\n      height: 0\n    });\n    var height = externalFontSize + paddingTop + paddingBottom;\n    assign(bounds, {\n      width: width,\n      height: height,\n      x: absoluteBBox.x - width / 2,\n      y: absoluteBBox.y - height / 2\n    });\n    assign(style, {\n      fontSize: externalFontSize + 'px',\n      lineHeight: externalLineHeight,\n      paddingTop: paddingTop + 'px',\n      paddingBottom: paddingBottom + 'px'\n    });\n  } // text annotations\n\n\n  if (is(element, 'bpmn:TextAnnotation')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height,\n      minWidth: 30 * zoom,\n      minHeight: 10 * zoom\n    });\n    assign(style, {\n      textAlign: 'left',\n      paddingTop: 5 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 7 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px',\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight\n    });\n  }\n\n  return {\n    bounds: bounds,\n    style: style\n  };\n};\n\nLabelEditingProvider.prototype.update = function (element, newLabel, activeContextText, bounds) {\n  var newBounds, bbox;\n\n  if (is(element, 'bpmn:TextAnnotation')) {\n    bbox = this._canvas.getAbsoluteBBox(element);\n    newBounds = {\n      x: element.x,\n      y: element.y,\n      width: element.width / bbox.width * bounds.width,\n      height: element.height / bbox.height * bounds.height\n    };\n  }\n\n  if (is(element, 'bpmn:Group')) {\n    var businessObject = getBusinessObject(element); // initialize categoryValue if not existing\n\n    if (!businessObject.categoryValueRef) {\n      var rootElement = this._canvas.getRootElement(),\n          definitions = getBusinessObject(rootElement).$parent;\n\n      var categoryValue = createCategoryValue(definitions, this._bpmnFactory);\n      getBusinessObject(element).categoryValueRef = categoryValue;\n    }\n  }\n\n  if (isEmptyText(newLabel)) {\n    newLabel = null;\n  }\n\n  this._modeling.updateLabel(element, newLabel, newBounds);\n}; // helpers //////////////////////\n\n\nfunction isCollapsedSubProcess(element) {\n  return is(element, 'bpmn:SubProcess') && !isExpanded(element);\n}\n\nfunction isExpandedSubProcess(element) {\n  return is(element, 'bpmn:SubProcess') && isExpanded(element);\n}\n\nfunction isCollapsedPool(element) {\n  return is(element, 'bpmn:Participant') && !isExpanded(element);\n}\n\nfunction isExpandedPool(element) {\n  return is(element, 'bpmn:Participant') && isExpanded(element);\n}\n\nfunction isEmptyText(label) {\n  return !label || !label.trim();\n}","map":{"version":3,"sources":["/Users/believecreative/Kumar/bpmn/node_modules/bpmn-js/lib/features/label-editing/LabelEditingProvider.js"],"names":["assign","getLabel","getBusinessObject","is","createCategoryValue","isAny","isExpanded","getExternalLabelMid","isLabelExternal","hasExternalLabel","isLabel","LabelEditingProvider","eventBus","bpmnFactory","canvas","directEditing","modeling","resizeHandles","textRenderer","_bpmnFactory","_canvas","_modeling","_textRenderer","registerProvider","on","event","activateDirectEdit","element","isActive","complete","e","cancel","removeResizers","context","shape","canExecute","isTouch","hints","createElementsBehavior","force","isCollapsedSubProcess","activate","$inject","prototype","text","undefined","bounds","getEditingBBox","options","centerVertically","autoResize","resizable","target","label","bbox","getAbsoluteBBox","mid","x","width","y","height","zoom","defaultStyle","getDefaultStyle","externalStyle","getExternalStyle","externalFontSize","fontSize","externalLineHeight","lineHeight","defaultFontSize","defaultLineHeight","style","fontFamily","fontWeight","isExpandedPool","paddingTop","paddingBottom","paddingLeft","paddingRight","transform","isCollapsedPool","isExpandedSubProcess","labelTarget","externalLabelMid","absoluteBBox","minWidth","minHeight","textAlign","update","newLabel","activeContextText","newBounds","businessObject","categoryValueRef","rootElement","getRootElement","definitions","$parent","categoryValue","isEmptyText","updateLabel","trim"],"mappings":"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","sourcesContent":["import {\n  assign\n} from 'min-dash';\n\nimport {\n  getLabel\n} from './LabelUtil';\n\nimport {\n  getBusinessObject,\n  is\n} from '../../util/ModelUtil';\n\nimport {\n  createCategoryValue\n} from '../modeling/behavior/util/CategoryUtil';\n\nimport { isAny } from '../modeling/util/ModelingUtil';\nimport { isExpanded } from '../../util/DiUtil';\n\nimport {\n  getExternalLabelMid,\n  isLabelExternal,\n  hasExternalLabel,\n  isLabel\n} from '../../util/LabelUtil';\n\n\nexport default function LabelEditingProvider(\n    eventBus, bpmnFactory, canvas, directEditing,\n    modeling, resizeHandles, textRenderer) {\n\n  this._bpmnFactory = bpmnFactory;\n  this._canvas = canvas;\n  this._modeling = modeling;\n  this._textRenderer = textRenderer;\n\n  directEditing.registerProvider(this);\n\n  // listen to dblclick on non-root elements\n  eventBus.on('element.dblclick', function(event) {\n    activateDirectEdit(event.element, true);\n  });\n\n  // complete on followup canvas operation\n  eventBus.on([\n    'autoPlace.start',\n    'canvas.viewbox.changing',\n    'drag.init',\n    'element.mousedown',\n    'popupMenu.open'\n  ], function(event) {\n\n    if (directEditing.isActive()) {\n      directEditing.complete();\n    }\n  });\n\n  // cancel on command stack changes\n  eventBus.on([ 'commandStack.changed' ], function(e) {\n    if (directEditing.isActive()) {\n      directEditing.cancel();\n    }\n  });\n\n\n  eventBus.on('directEditing.activate', function(event) {\n    resizeHandles.removeResizers();\n  });\n\n  eventBus.on('create.end', 500, function(event) {\n\n    var context = event.context,\n        element = context.shape,\n        canExecute = event.context.canExecute,\n        isTouch = event.isTouch;\n\n    // TODO(nikku): we need to find a way to support the\n    // direct editing on mobile devices; right now this will\n    // break for desworkflowediting on mobile devices\n    // as it breaks the user interaction workflow\n\n    // TODO(nre): we should temporarily focus the edited element\n    // here and release the focused viewport after the direct edit\n    // operation is finished\n    if (isTouch) {\n      return;\n    }\n\n    if (!canExecute) {\n      return;\n    }\n\n    if (context.hints && context.hints.createElementsBehavior === false) {\n      return;\n    }\n\n    activateDirectEdit(element);\n  });\n\n  eventBus.on('autoPlace.end', 500, function(event) {\n    activateDirectEdit(event.shape);\n  });\n\n\n  function activateDirectEdit(element, force) {\n    if (force ||\n        isAny(element, [ 'bpmn:Task', 'bpmn:TextAnnotation', 'bpmn:Group' ]) ||\n        isCollapsedSubProcess(element)) {\n\n      directEditing.activate(element);\n    }\n  }\n\n}\n\nLabelEditingProvider.$inject = [\n  'eventBus',\n  'bpmnFactory',\n  'canvas',\n  'directEditing',\n  'modeling',\n  'resizeHandles',\n  'textRenderer'\n];\n\n\n/**\n * Activate direct editing for activities and text annotations.\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object with properties bounds (position and size), text and options\n */\nLabelEditingProvider.prototype.activate = function(element) {\n\n  // text\n  var text = getLabel(element);\n\n  if (text === undefined) {\n    return;\n  }\n\n  var context = {\n    text: text\n  };\n\n  // bounds\n  var bounds = this.getEditingBBox(element);\n\n  assign(context, bounds);\n\n  var options = {};\n\n  // tasks\n  if (\n    isAny(element, [\n      'bpmn:Task',\n      'bpmn:Participant',\n      'bpmn:Lane',\n      'bpmn:CallActivity'\n    ]) ||\n    isCollapsedSubProcess(element)\n  ) {\n    assign(options, {\n      centerVertically: true\n    });\n  }\n\n  // external labels\n  if (isLabelExternal(element)) {\n    assign(options, {\n      autoResize: true\n    });\n  }\n\n  // text annotations\n  if (is(element, 'bpmn:TextAnnotation')) {\n    assign(options, {\n      resizable: true,\n      autoResize: true\n    });\n  }\n\n  assign(context, {\n    options: options\n  });\n\n  return context;\n};\n\n\n/**\n * Get the editing bounding box based on the element's size and position\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object containing information about position\n *                  and size (fixed or minimum and/or maximum)\n */\nLabelEditingProvider.prototype.getEditingBBox = function(element) {\n  var canvas = this._canvas;\n\n  var target = element.label || element;\n\n  var bbox = canvas.getAbsoluteBBox(target);\n\n  var mid = {\n    x: bbox.x + bbox.width / 2,\n    y: bbox.y + bbox.height / 2\n  };\n\n  // default position\n  var bounds = { x: bbox.x, y: bbox.y };\n\n  var zoom = canvas.zoom();\n\n  var defaultStyle = this._textRenderer.getDefaultStyle(),\n      externalStyle = this._textRenderer.getExternalStyle();\n\n  // take zoom into account\n  var externalFontSize = externalStyle.fontSize * zoom,\n      externalLineHeight = externalStyle.lineHeight,\n      defaultFontSize = defaultStyle.fontSize * zoom,\n      defaultLineHeight = defaultStyle.lineHeight;\n\n  var style = {\n    fontFamily: this._textRenderer.getDefaultStyle().fontFamily,\n    fontWeight: this._textRenderer.getDefaultStyle().fontWeight\n  };\n\n  // adjust for expanded pools AND lanes\n  if (is(element, 'bpmn:Lane') || isExpandedPool(element)) {\n\n    assign(bounds, {\n      width: bbox.height,\n      height: 30 * zoom,\n      x: bbox.x - bbox.height / 2 + (15 * zoom),\n      y: mid.y - (30 * zoom) / 2\n    });\n\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: (7 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (5 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px',\n      transform: 'rotate(-90deg)'\n    });\n  }\n\n\n  // internal labels for tasks and collapsed call activities,\n  // sub processes and participants\n  if (isAny(element, [ 'bpmn:Task', 'bpmn:CallActivity']) ||\n      isCollapsedPool(element) ||\n      isCollapsedSubProcess(element)) {\n\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height\n    });\n\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: (7 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (5 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px'\n    });\n  }\n\n\n  // internal labels for expanded sub processes\n  if (isExpandedSubProcess(element)) {\n    assign(bounds, {\n      width: bbox.width,\n      x: bbox.x\n    });\n\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: (7 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (5 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px'\n    });\n  }\n\n  var width = 90 * zoom,\n      paddingTop = 7 * zoom,\n      paddingBottom = 4 * zoom;\n\n  // external labels for events, data elements, gateways, groups and connections\n  if (target.labelTarget) {\n    assign(bounds, {\n      width: width,\n      height: bbox.height + paddingTop + paddingBottom,\n      x: mid.x - width / 2,\n      y: bbox.y - paddingTop\n    });\n\n    assign(style, {\n      fontSize: externalFontSize + 'px',\n      lineHeight: externalLineHeight,\n      paddingTop: paddingTop + 'px',\n      paddingBottom: paddingBottom + 'px'\n    });\n  }\n\n  // external label not yet created\n  if (isLabelExternal(target)\n      && !hasExternalLabel(target)\n      && !isLabel(target)) {\n\n    var externalLabelMid = getExternalLabelMid(element);\n\n    var absoluteBBox = canvas.getAbsoluteBBox({\n      x: externalLabelMid.x,\n      y: externalLabelMid.y,\n      width: 0,\n      height: 0\n    });\n\n    var height = externalFontSize + paddingTop + paddingBottom;\n\n    assign(bounds, {\n      width: width,\n      height: height,\n      x: absoluteBBox.x - width / 2,\n      y: absoluteBBox.y - height / 2\n    });\n\n    assign(style, {\n      fontSize: externalFontSize + 'px',\n      lineHeight: externalLineHeight,\n      paddingTop: paddingTop + 'px',\n      paddingBottom: paddingBottom + 'px'\n    });\n  }\n\n  // text annotations\n  if (is(element, 'bpmn:TextAnnotation')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height,\n      minWidth: 30 * zoom,\n      minHeight: 10 * zoom\n    });\n\n    assign(style, {\n      textAlign: 'left',\n      paddingTop: (5 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (7 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px',\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight\n    });\n  }\n\n  return { bounds: bounds, style: style };\n};\n\n\nLabelEditingProvider.prototype.update = function(\n    element, newLabel,\n    activeContextText, bounds) {\n\n  var newBounds,\n      bbox;\n\n  if (is(element, 'bpmn:TextAnnotation')) {\n\n    bbox = this._canvas.getAbsoluteBBox(element);\n\n    newBounds = {\n      x: element.x,\n      y: element.y,\n      width: element.width / bbox.width * bounds.width,\n      height: element.height / bbox.height * bounds.height\n    };\n  }\n\n  if (is(element, 'bpmn:Group')) {\n\n    var businessObject = getBusinessObject(element);\n\n    // initialize categoryValue if not existing\n    if (!businessObject.categoryValueRef) {\n\n      var rootElement = this._canvas.getRootElement(),\n          definitions = getBusinessObject(rootElement).$parent;\n\n      var categoryValue = createCategoryValue(definitions, this._bpmnFactory);\n\n      getBusinessObject(element).categoryValueRef = categoryValue;\n    }\n\n  }\n\n  if (isEmptyText(newLabel)) {\n    newLabel = null;\n  }\n\n  this._modeling.updateLabel(element, newLabel, newBounds);\n};\n\n\n\n// helpers //////////////////////\n\nfunction isCollapsedSubProcess(element) {\n  return is(element, 'bpmn:SubProcess') && !isExpanded(element);\n}\n\nfunction isExpandedSubProcess(element) {\n  return is(element, 'bpmn:SubProcess') && isExpanded(element);\n}\n\nfunction isCollapsedPool(element) {\n  return is(element, 'bpmn:Participant') && !isExpanded(element);\n}\n\nfunction isExpandedPool(element) {\n  return is(element, 'bpmn:Participant') && isExpanded(element);\n}\n\nfunction isEmptyText(label) {\n  return !label || !label.trim();\n}"]},"metadata":{},"sourceType":"module"}